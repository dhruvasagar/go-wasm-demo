<!DOCTYPE html>
<html>
<head>
    <title>Quick Performance Test</title>
    <script src="wasm_exec.js"></script>
</head>
<body>
    <h1>Quick WASM vs JS Test</h1>
    <div id="results"></div>
    
    <script>
        let wasmReady = false;

        // Simple JavaScript implementation
        function mandelbrotJS(width, height, xmin, xmax, ymin, ymax, maxIter) {
            const result = [];
            const dx = (xmax - xmin) / width;
            const dy = (ymax - ymin) / height;
            
            for (let py = 0; py < height; py++) {
                const y = ymin + py * dy;
                for (let px = 0; px < width; px++) {
                    const x = xmin + px * dx;
                    
                    let zx = 0, zy = 0;
                    let iter = 0;
                    
                    while (iter < maxIter && zx*zx + zy*zy < 4.0) {
                        const newZy = 2 * zx * zy + y;
                        zx = zx*zx - zy*zy + x;
                        zy = newZy;
                        iter++;
                    }
                    
                    result.push(iter);
                }
            }
            
            return result;
        }

        async function runTest() {
            if (!wasmReady) {
                document.getElementById('results').innerHTML = 'WASM not ready yet...';
                return;
            }

            const width = 600;
            const height = 450;
            const maxIter = 150;
            const xmin = -2.5, xmax = 1.5, ymin = -1.5, ymax = 1.5;

            console.log('Running performance test...');

            // Test JavaScript (5 runs)
            let jsTimes = [];
            for (let i = 0; i < 5; i++) {
                const start = performance.now();
                mandelbrotJS(width, height, xmin, xmax, ymin, ymax, maxIter);
                jsTimes.push(performance.now() - start);
            }

            // Test WASM (5 runs)
            let wasmTimes = [];
            for (let i = 0; i < 5; i++) {
                const start = performance.now();
                window.mandelbrotWasm(width, height, xmin, xmax, ymin, ymax, maxIter);
                wasmTimes.push(performance.now() - start);
            }

            const jsAvg = jsTimes.reduce((a, b) => a + b) / jsTimes.length;
            const wasmAvg = wasmTimes.reduce((a, b) => a + b) / wasmTimes.length;

            const speedup = jsAvg / wasmAvg;
            const winner = speedup > 1 ? 'WASM' : 'JavaScript';

            document.getElementById('results').innerHTML = `
                <h2>Results:</h2>
                <p><strong>JavaScript Average:</strong> ${jsAvg.toFixed(1)}ms</p>
                <p><strong>WebAssembly Average:</strong> ${wasmAvg.toFixed(1)}ms</p>
                <p><strong>Winner:</strong> ${winner} (${Math.abs(speedup).toFixed(2)}x ${speedup > 1 ? 'faster' : 'slower'})</p>
                <p><strong>JS Times:</strong> [${jsTimes.map(t => t.toFixed(1)).join(', ')}]</p>
                <p><strong>WASM Times:</strong> [${wasmTimes.map(t => t.toFixed(1)).join(', ')}]</p>
            `;

            console.log(`JS: ${jsAvg.toFixed(1)}ms, WASM: ${wasmAvg.toFixed(1)}ms, Speedup: ${speedup.toFixed(2)}x`);
        }

        // Initialize WebAssembly
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
                wasmReady = true;
                console.log('WASM loaded, running test...');
                setTimeout(runTest, 1000);
            })
            .catch((error) => {
                console.error("Failed to load WASM:", error);
                document.getElementById('results').innerHTML = 'Failed to load WebAssembly';
            });
    </script>
</body>
</html>